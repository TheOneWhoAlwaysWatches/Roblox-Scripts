-- âš¡ Reliable Insta-Kill Aura (Fix for missed hits after respawn)

-- CONFIG
local auraRange = 25
local auraSize = Vector3.new(30, 30, 30) -- slightly bigger box
local attackRate = 0.05

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- STATE
local running = true
local auraParams = OverlapParams.new()
auraParams.FilterType = Enum.RaycastFilterType.Include

-- HELPERS
local function getChar(plr)
    return plr and plr.Character
end

local function getHRP(plr)
    local char = getChar(plr)
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function getHum(plr)
    local char = getChar(plr)
    return char and char:FindFirstChildOfClass("Humanoid")
end

local function getValidTargets()
    local myHRP = getHRP(LocalPlayer)
    if not myHRP then return {}, {} end

    local playersInRange, chars = {}, {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local hrp = getHRP(player)
            if hrp and (hrp.Position - myHRP.Position).Magnitude <= auraRange then
                table.insert(playersInRange, player)
                local char = getChar(player)
                if char then table.insert(chars, char) end
            end
        end
    end
    return playersInRange, chars
end

local function getTouchPart(tool)
    local tx = tool and tool:FindFirstChildWhichIsA("TouchTransmitter", true)
    return tx and tx.Parent
end

local function autoEquip(tool)
    local char = getChar(LocalPlayer)
    if char and not tool:IsDescendantOf(char) then
        tool.Parent = char
        task.wait() -- ensure equip finishes
    end
    tool:Activate()
end

-- MAIN LOOP
task.spawn(function()
    while running do
        local myChar = getChar(LocalPlayer)
        if not myChar then task.wait(1) continue end

        local targets, enemyChars = getValidTargets()
        auraParams.FilterDescendantsInstances = enemyChars

        for _, tool in ipairs(myChar:GetChildren()) do
            if tool:IsA("Tool") then
                local fightEvent = tool:FindFirstChild("FightEvent")
                local touchPart = getTouchPart(tool)

                if fightEvent then
                    autoEquip(tool)
                    -- ðŸ”¹ Try to target Humanoids directly (more reliable than blank FireServer)
                    for _, enemy in ipairs(targets) do
                        local hum = getHum(enemy)
                        if hum then
                            pcall(function() fightEvent:FireServer(hum) end)
                        else
                            pcall(function() fightEvent:FireServer() end)
                        end
                    end
                end

                if touchPart then
                    local partsInBox = workspace:GetPartBoundsInBox(
                        touchPart.CFrame,
                        touchPart.Size + auraSize,
                        auraParams
                    )

                    local hitDone = {}
                    for _, part in ipairs(partsInBox) do
                        local model = part:FindFirstAncestorWhichIsA("Model")
                        if model and table.find(enemyChars, model) and not hitDone[model] then
                            hitDone[model] = true
                            firetouchinterest(touchPart, part, 1)
                            firetouchinterest(touchPart, part, 0)
                        end
                    end

                    -- ðŸ”¹ Backup guaranteed hit (directly touch HRP if in range)
                    for _, enemy in ipairs(targets) do
                        local hrp = getHRP(enemy)
                        if hrp and not hitDone[enemy.Character] then
                            firetouchinterest(touchPart, hrp, 1)
                            firetouchinterest(touchPart, hrp, 0)
                        end
                    end
                end
            end
        end

        RunService.Heartbeat:Wait()
        task.wait(attackRate)
    end
end)

-- RESET ON DEATH
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.2) -- let tools load properly
    running = true
end)

print("[âœ…] Reliable Insta-Kill Aura Activated")
